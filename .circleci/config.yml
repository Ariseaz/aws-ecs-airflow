orbs:
  aws-cli: circleci/aws-cli@x.y
version: 2.1
workflows:
  aws-cli:
    jobs:
      - aws-cli:
          context: aws
  description: |
    Configure and store AWS credentials in
    ~/.aws/credentials and ~/.aws/config
  parameters:
    aws-access-key-id:
      default: AWS_ACCESS_KEY_ID
      description: |
        AWS access key id for IAM role. Set this to the name of
        the environment variable you will use to hold this
        value, i.e. AWS_ACCESS_KEY.
      type: env_var_name
    aws-region:
      default: AWS_DEFAULT_REGION
      description: |
        Env var of AWS region to operate in
        (defaults to AWS_DEFAULT_REGION)
      type: env_var_name
    aws-secret-access-key:
      default: AWS_SECRET_ACCESS_KEY
      description: |
        AWS secret key for IAM role. Set this to the name of
        the environment variable you will use to hold this
        value, i.e. $AWS_SECRET_ACCESS_KEY.
      type: env_var_name

jobs:
  plan-apply:
    working_directory: /environ/dev
    docker:
      - image: hashicorp/terraform:light
    steps:
      - checkout
      - run:
          name: terraform init & plan
          command: |
            terraform init -input=false
            terraform plan -out tfapply -var-file variables.tfvars
      - persist_to_workspace:
          root: .
          paths:
            - .